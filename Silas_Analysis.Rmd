---
title: "Silas_Analysis"
author: "Max Kuttner"
date: "25 3 2020"
output:
  pdf_document: default
  word_document: default
  html_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
```

```{r libs, include=FALSE}
library(ggplot2)
library(tidyverse)
library(dplyr)
library(stats)
library(xts)
library(forecast)
library(stats)
library(lmtest)
```

```{r setwd, include=FALSE}
setwd("C:/Users/maxku/OneDrive/Documents/Silas/Silas_Project")
```

```{r readxlsx}
# read-in excel data
df <- readxl::read_excel("Data_Is_Key.xlsx")
```

```{r datawrangling, include=FALSE}
# rename and convert Data
df <- df %>% rename(Datum = `Datum (jjmmtt)`) %>% mutate(Datum = as.Date(Datum, format = "%y%m%d"))

df <- df %>% mutate_at(c("Flughafen", "Airline", "Zeit", "Device", "Datenzugriff"), as.factor) %>% 
  mutate_at(c("Cookies", "IP-Adresse"), as.logical)

df <- df %>% rename(Preis = `Preis (€)`) %>% rename(IP_Adresse = `IP-Adresse`)


```

## Hypothese 1
**[Erfolgt die Buchung von Flugtickets Dienstagabends, kann statistisch gesehen das preiswerteste Offert erzielt werden.]**

```{r data_H1, echo=FALSE}
# 1)
# Modell 1: Preis in Abhängigkeit von Zeit und Datum

# Dazu müssen wir zuerst Datum nach Mo, Di, Mi, ... kategorisieren

df1 <- df %>% mutate(Datum = weekdays(Datum)) %>% mutate(Datum = factor(Datum, levels = c("Montag",
                                                                                          "Dienstag",
                                                                                          "Mittwoch",
                                                                                          "Donnerstag",
                                                                                          "Freitag",
                                                                                          "Samstag",
                                                                                          "Sonntag"))) %>%
  filter(Device == 0 & Datenzugriff == 0 & Cookies == FALSE & IP_Adresse == FALSE) %>% 
  unite(Flughafen_Airline, c("Flughafen", "Airline"), sep = "") %>% 
  select(Flughafen_Airline,Preis, Datum, Zeit) 

levels(df1$Zeit) <- c("Morgen", "Mittag", "Abend")
#levels(df1$Datum)
#str(df)
```

### Deskreptive Statistik:

```{r DStat_H1, echo=FALSE}
jmv::descriptives(df1, vars = c("Preis", "Datum", "Zeit"), sd = TRUE, missing = TRUE, freq = TRUE)
```

### Verteilung - BoxPlot
```{r boxplot_H1, fig.width=15, fig.height=7}
# Plot Box_Plot
ggplot(df1, aes(Datum, Preis)) +
  geom_boxplot(aes(fill = Datum), show.legend = TRUE) +
  geom_point() +
  facet_wrap(~Zeit)
```


### Mehrfakorielle ANOVA:
```{r multANOVA_H1, fig.width=15, fig.height=7}
# Mehrfakorielle ANOVA:

Anova1<-jmv::ANOVA(data = df1, 
           dep = "Preis",
           factors = c("Datum", "Zeit"),
           modelTerms = list("Datum", "Zeit"),
           effectSize = "partEta",
           emMeans = list(
             c("Datum", "Zeit")
           ),
           emmTables = TRUE
           )
Anova1
```





```{r EMM1_H1}
# Emm korrigiert Missverhältnisse aus unterschiedlich großen Sample-Größen für einzelne Tage.
# Somit wird jeder Tag/Uhrzeit gleich gewertet.
Emm1<-as_tibble(Anova1$emm[[1]]$emmTable)
```
Estimated marginal means korrigiert Missverhältnisse aus unterschiedlich großen Sample-Größen für einzelne Tage. Somit wird jeder/jede Tag/Uhrzeit gleich gewertet. Wie oft jeder einzelne Tag gemessen wurde bzw. im Datensatz vorkommt, ist in der deskriptiven Statistik unter **FREQUENCIES** zu sehen. Für mehr Infos zum EMM: https://cran.r-project.org/web/packages/emmeans/vignettes/basics.html \newline

Im folgenden werden Tage und Uhrzeiten nach ihrem mean (also **Preis**) angeordnet.
````{r EMM2_H1}
Emm1 %>% arrange(mean)
````

## Hypothese 2
**[Je spontaner und kurzfristiger die Kaufentscheidung getroffen wird, desto höher ist der offerierte Preis einer Airline.]**

````{r data_H2}
# Für alle Flüge pro Datum
df_time <- df %>% 
  filter(Device == 0 & Datenzugriff == 0 & Cookies == FALSE & IP_Adresse == FALSE)%>% select(Datum, Preis) %>% 
  group_by(Datum) %>%
  dplyr::summarise(mean_Preis = mean(Preis))

#create time series

## Create a daily Date object - helps my work on dates
inds <- seq(as.Date("2019-08-01"), as.Date("2020-01-19"), by = "day")

## Create a time series object
myts <- ts(df_time[,2],     # Preis-data
           start = c(2019, as.numeric(format(inds[1], "%j"))),
           frequency = 365)

fit <- auto.arima(myts)

df_time_fity<- cbind(df_time, as.numeric(fit$fitted))
colnames(df_time_fity)[3]<- "fitted"

# create forecast:
#forecast bis zum 1. Februar
fore <- forecast(fit, h = 13)
````

**Diese Zeitreihe lässt sich mit einem ARIMA(2,2,1)-Modell modellieren.**
````{r Arima_H2}
summary(fit)
# coefficient-test
coeftest(fit)
````
**Mit diesem Modell kann in weiterer Folge die Zeitrehe angenähert werden und bis zum 1.Februar 2020 vorhergesagt werden.**

````{r TSPlot1_H2, fig.width=15, fig.height=7}
# Plot 1
ggplot() +
  geom_line(data = df_time_fity, aes(x = Datum, y = mean_Preis, color = "Data")) +
  geom_line(data = df_time_fity, aes(x = Datum, y = fitted, color = "Fitted")) +
  scale_color_manual(name = "Lines", 
                     values = c("Data" = "black", "Fitted" = "red")) +
  ylab("Preis")+
  ggtitle('Zeitreihe - Flugpreise')
````

````{r ForecastPlot_H2, fig.width=15, fig.height=7}
# Plot 2: Forecast
autoplot(fore) +
  xlab("Datum") +
  ylab("Preis") 
````

````{r TSPlot2_H2, fig.width=15, fig.height=7}
# Für jeden Flug zu jedem Datum
df_time <- df %>%
  filter(Device == 0 & Datenzugriff == 0 & Cookies == FALSE & IP_Adresse == FALSE) %>% 
  select(Flughafen, Airline, Datum, Preis) %>% 
  mutate(Flughafen = as.character(Flughafen)) %>% 
  mutate(Airline = as.character(Airline)) %>% 
  group_by(Flughafen, Airline, Datum) %>%
  dplyr::summarise(mean_Preis = mean(Preis)) %>% 
  unite(Flughafen_Airline, c("Flughafen", "Airline"), sep = "")

ggplot(data=df_time, aes(x=Datum, y=mean_Preis)) +
  geom_line(aes(group = Flughafen_Airline, colour = Flughafen_Airline )) 
````


````{r forecast_every_single_flug, fig.width=15, fig.height=7, warning = FALSE}


for (flug in unique(df_time$Flughafen_Airline)){
  
  df_time_single <- df_time %>% filter(Flughafen_Airline == flug)
  #create time series
  
  ## Create a time series object
  myts <- ts(df_time_single[,3],     # Preis-data
             start = c(2019, as.numeric(format(inds[2], "%j"))),
             frequency = 365)
  
  fit <- auto.arima(myts)
  
  df_time_fity<- cbind(df_time_single, as.numeric(fit$fitted))
  colnames(df_time_fity)[4]<- "fitted"
  
  # create forecast:
  #forecast bis zum 1. Februar
  fore <- forecast(fit, h = 13)
  
    #summary(fit)
  # coefficient-test
  #coeftest(fit)
  

    gplot <- autoplot(fore) +
    xlab("Datum") +
    ylab("Preis") +
    ggplot2::ggtitle(paste('Forecast - Flug:', flug, '/ Model:', fore$method, sep = ' '))
    
    print(gplot)
}
````




### Interpretation - H2
Man kann in allen Plot gut erkennen, dass der Preisverlauf annähernd einem exponentiellen Trend folgt. Dieser Trend (wie im letzten Plot gezeigt) zu einem erheblichen Anteil von den rasanten Preissteigerungen der Flüge 67 und 60 getragen. Das exponentielle Wachstum in der nähe des Abflugsdatums beweist auch unser Forecast, der weiter Preissteigerungen bis zum 1.Februar 2020 vorhersagt. Da die Koeffizienten des ARIMA(2,2,1)-Modells signifkant sind besteht Grund zur Annahme, dass die Preise bei kurzfristigem Buchen stark steigen. Das heißt, die Hypothese 2 wird beibehalten.


## Hypothese 3
**[Die Wahl des Betriebssystems respektive die Marke des Nutzerendgeräts mit dem die Reise-Website abgerufen wird, hat eine Auswirkung auf den offerierten Preis einer Airline.]**

```{r data_H3}
#filter data frame
df3 <- df %>%
  filter(Datenzugriff == 0 & Cookies == TRUE & IP_Adresse == FALSE) %>% 
  select(Preis, Device)

# Change factor levels:
df3$Device<-as.numeric(df3$Device)
df3$Device <- df3$Device - 1
df3 <- df3 %>% filter(Device %in% c(1,2))
df3$Device <- as.factor(df3$Device)
```

### Deskreptive Statistik:

```{r DStat_H3, echo=FALSE}
# Deskreptive Statistik:
jmv::descriptives(df3, vars = c("Preis", "Device"), sd = TRUE, missing = TRUE, freq = TRUE)
```

### Verteilung - BoxPlot
```{r boxplot_H3, fig.width=10, fig.height=7}
# Plot Box_Plot
ggplot(df3, aes(Device, Preis)) +
  geom_boxplot(aes(fill = Device), show.legend = TRUE) +
  geom_point()
```

### Einfaktorielle ANOVA:
```{r simpleANOVA_H3}
# Einfaktorielle ANOVA ( selbes Ergebnis, wie in summary(lm3) ):

Anova3<-jmv::ANOVA(data = df3, 
                   dep = "Preis",
                   factors = c("Device"),
                   emMeans = list("Device"
                   ),
                   emmTables = TRUE)
Anova3
```


### Interpretation - H3

Die ANOVA bestätigt, dass es keine signifikante Unterschiede zwischen den Gruppen gibt. Das heißt, die Hypothese 3 wird verworfen.

## Hypothese 4
**[Hypothese 4: Das Abrufen einer Reise-Website mittels Applikation und Website erwirkt einen Unterschied des offerierten Preises einer Airline.]**

```{r data_H4}
#filter data frame: Website, Application
df4 <- df %>%
  filter(Datenzugriff %in% c(0,1) & Cookies == TRUE & IP_Adresse == FALSE) %>% 
  select(Preis, Device, Datenzugriff) 

# Change factor levels:
df4$Device<-as.numeric(df4$Device)
df4$Device <- df4$Device - 1
df4 <- df4 %>% filter(Device %in% c(1,3))
df4$Device <- as.factor(df4$Device)

#str(df4)
```

### Deskreptive Statistik:

```{r DStat_H4, echo=FALSE}
# Deskreptive Statistik:
jmv::descriptives(df4, vars = c("Preis", "Device"), sd = TRUE, missing = TRUE, freq = TRUE)
```

### Verteilung - BoxPlot
```{r boxplot_H4, fig.width=10, fig.height=7}
# Plot Box_Plot
ggplot(df4, aes(Device, Preis)) +
  geom_boxplot(aes(fill = Device), show.legend = TRUE) +
  geom_point()
```

### Einfaktorielle ANOVA:
```{r simpleANOVA_H4}
# Einfaktorielle ANOVA :

Anova4<-jmv::ANOVA(data = df4, 
                   dep = "Preis",
                   factors = c("Device"),
                   modelTerms = list("Device"),
                   effectSize = "partEta",
                   emMeans = list("Device"
                   ),
                   emmTables = TRUE)
Anova4
```

### Interpretation - H4

 Es lässt sich ein signifikanter Unterschied im Preis zwischen den zwei Gruppen feststellen. Der Emm-Table zeigt, dass der höhere Preis bei Mac-Books (3) angeboten wird. Es besteht Beweis für die Hypothese 4. Diese wird daher beibehalten.

## Hypothese 6
**[Das Zurücksetzen von Cookies respektive dem Browserverlauf erwirkt ein Sinken des offerierten Preises einer Airline.]**

````{r data_H5}
# H6 = H5

# filter data
df5 <- df %>%
  filter(Datenzugriff == 0 & IP_Adresse == FALSE & Device %in% c(0, 1)) %>% 
  select(Preis, Cookies, Device)
colnames(df5)[2]<-"Cookies_reset"
````

### Deskreptive Statistik:
````{r DStat_H5}
# Deskreptive Statistik:
jmv::descriptives(df5, vars = c("Preis", "Cookies_reset"), sd = TRUE, missing = TRUE, freq = TRUE)
````

### Verteilung - BoxPlot
```{r boxplot_H5, fig.width=10, fig.height=7}
# Plot Box_Plot
ggplot(df5, aes(Cookies_reset, Preis)) +
  geom_boxplot(aes(fill = Cookies_reset), show.legend = TRUE) +
  geom_point()
```


### Einfaktorielle ANOVA:
```{r simpleANOVA_H5}
# Einfaktorielle ANOVA :

Anova5<-jmv::ANOVA(data = df5, 
                   dep = "Preis",
                   factors = c("Cookies_reset"),
                   modelTerms = list("Cookies_reset"),
                   effectSize = "partEta",
                   emMeans = list("Cookies_reset"
                   ),
                   emmTables = TRUE)
Anova5
```

### Interpretation - H6

Zunächst gibt es wieder eine große Ungleichheit zwischen den erfassten Cookie-Daten. Zu beachten ist, dass die Variable cookies_reset eine binäre Variable darstellt und die Codierung TRUE = 'zurückgesetzt' und FALSE = 'Zugelassen' beinhaltet. Nach der einfaktoriellen ANOVA ist nach dem p-Wert die Nullhypothese beizubehalten. Das heißt, es gibt einen signifikanten Unterschied zwischen den zwei Gruppen, ceteris paribus. 

## Hypothese 7
**[Das Verbergen der Internetprotokoll-Adresse und folglich der ortsspezifischen Parameter mittels Virtual Private Network verursacht eine Differenz im offerierten Preis einer Airline.]**

````{r data_H6}
# filter data
df6 <- df %>% 
  filter(Device == 3 & Datenzugriff == 1 & Cookies == TRUE) %>% 
  select(Preis, IP_Adresse)
colnames(df6)[2]<-"IP_Adresse_hidden"
````

### Deskreptive Statistik:
````{r DStat_H6}
# Deskreptive Statistik:
jmv::descriptives(df6, vars = c("Preis", "IP_Adresse_hidden"), sd = TRUE, missing = TRUE, freq = TRUE)
````

### Verteilung - BoxPlot
```{r boxplot_H6, fig.width=10, fig.height=7}
# Plot Box_Plot
ggplot(df6, aes(IP_Adresse_hidden, Preis)) +
  geom_boxplot(aes(fill = IP_Adresse_hidden), show.legend = TRUE) +
  geom_point()
```


### Einfaktorielle ANOVA:
```{r simpleANOVA_H6}
# Einfaktorielle ANOVA :

Anova5<-jmv::ANOVA(data = df6, 
                   dep = "Preis",
                   factors = c("IP_Adresse_hidden"),
                   modelTerms = list("IP_Adresse_hidden"),
                   effectSize = "partEta",
                   emMeans = list("IP_Adresse_hidden"
                   ),
                   emmTables = TRUE)
Anova5
```

### Interpretation - H7

Es gibt eine Ungleichheit zwischen den erfassten IP-Adressen-Daten. Zu beachten ist, dass die Variable IP_Adresse_hidden eine binäre Variable darstellt und die Codierung TRUE = 'verborgen' und FALSE = 'sichtbar' beinhaltet. Nach der einfaktoriellen ANOVA ist nach dem p-Wert die Nullhypothese beizubehalten. Das heißt, es gibt keinen signifikanten Unterschied im Mittelwert der zwei Gruppen. Bei Betrachtung des Emm ist ersichtlich, dass das **Verbergen** der Cookies mit einem vermutlich höheren mittleren Preis verbunden ist.


## Hypothese 8
**[Das Abrufen eines Flugpreises via Reise-Website führt, verglichen mit der Website der Airline selbst, zu einem höheren offerierten Preis.]**

```{r data_H7}
#filter data frame: Website, Application
df7 <- df %>% 
  filter(Device == 3 & Cookies == TRUE & IP_Adresse == FALSE) %>% 
  select(Preis, Datenzugriff) 
# Change factor levels:
df7$Datenzugriff<-as.numeric(df7$Datenzugriff)
df7$Datenzugriff <- df7$Datenzugriff - 1
df7 <- df7 %>% filter(Datenzugriff %in% c(1,2))
df7$Datenzugriff <- as.factor(df7$Datenzugriff)
```

### Deskreptive Statistik:

```{r DStat_H7, echo=FALSE}
# Deskreptive Statistik:
jmv::descriptives(df7, vars = c("Preis", "Datenzugriff"), sd = TRUE, missing = TRUE, freq = TRUE)
```

### Verteilung - BoxPlot
```{r boxplot_H7, fig.width=10, fig.height=7}
# Plot Box_Plot
ggplot(df7, aes(Datenzugriff, Preis)) +
  geom_boxplot(aes(fill = Datenzugriff), show.legend = TRUE) +
  geom_point()
```

### Einfaktorielle ANOVA:
```{r simpleANOVA_H7}
# Einfaktorielle ANOVA :

Anova7<-jmv::ANOVA(data = df7, 
                   dep = "Preis",
                   factors = c("Datenzugriff"),
                   modelTerms = list("Datenzugriff"),
                   effectSize = "partEta",
                   emMeans = list("Datenzugriff"
                   ),
                   emmTables = TRUE)
Anova7
```

### Interpretation - H8

Die Unterschiede sind nicht signfikant. Das heißt, die Nullhypothese wird beibehalten. Es konnte nicht nachgewiesen werden, dass es unterschiedliche Preise für **Website (1)** und **Reise-Website (2)** gibt. Zudem gibt es Disbalancen zwischen den Sample-Größen der Merkmale.




